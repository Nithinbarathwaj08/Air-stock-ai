# app.py
import os
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import requests
from datetime import datetime, timedelta
import openai
from scipy.stats import norm

# Optional: technical indicators using simple formulas (no external TA lib required)
def ema(series, span):
    return series.ewm(span=span, adjust=False).mean()

def rsi(series, period=14):
    delta = series.diff()
    up = delta.clip(lower=0).fillna(0)
    down = -1 * delta.clip(upper=0).fillna(0)
    ma_up = up.rolling(period).mean()
    ma_down = down.rolling(period).mean()
    rs = ma_up / ma_down
    return 100 - (100 / (1 + rs))

def macd(series, fast=12, slow=26, signal=9):
    ema_fast = ema(series, fast)
    ema_slow = ema(series, slow)
    macd_line = ema_fast - ema_slow
    signal_line = macd_line.ewm(span=signal, adjust=False).mean()
    hist = macd_line - signal_line
    return macd_line, signal_line, hist

def vwap(df):
    return (df['Close'] * df['Volume']).cumsum() / df['Volume'].cumsum()

# Black-Scholes Greeks (for European approx) - best-effort
def bs_greeks(S, K, T, r, sigma, option_type="call"):
    if T <= 0 or sigma <= 0:
        return {"delta":0,"gamma":0,"vega":0,"theta":0,"rho":0}
    d1 = (np.log(S / K) + (r + 0.5 * sigma**2) * T) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    if option_type == "call":
        delta = norm.cdf(d1)
    else:
        delta = -norm.cdf(-d1)
    gamma = norm.pdf(d1) / (S * sigma * np.sqrt(T))
    vega = S * norm.pdf(d1) * np.sqrt(T)
    theta = (-S * norm.pdf(d1) * sigma / (2 * np.sqrt(T)) - r * K * np.exp(-r * T) * norm.cdf(d2 if option_type=="call" else -d2))
    rho = K * T * np.exp(-r * T) * norm.cdf(d2 if option_type=="call" else -d2)
    return {"delta": float(delta), "gamma": float(gamma), "vega": float(vega/100), "theta": float(theta/365), "rho": float(rho)}

# OpenAI setup (reads from env)
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
if OPENAI_KEY:
    openai.api_key = OPENAI_KEY

# Optional News API key
NEWS_KEY = os.getenv("NEWS_API_KEY")  # optional

st.set_page_config(page_title="AI Stock Analyst (NSE F&O)", layout="wide")
st.title("ðŸ“ˆ AI Stock Analyst â€” NSE F&O (Prototype)")

col1, col2 = st.columns([2,1])

with col2:
    st.write("### Settings")
    symbol_input = st.text_input("NSE symbol (without .NS) â€” e.g. ICICIBANK or TCS", "ICICIBANK")
    full_symbol = symbol_input.strip().upper() + ".NS"
    interval = st.selectbox("Interval", ["15m","30m","60m","1d"], index=0)
    days_back = st.slider("History (days)", min_value=5, max_value=90, value=30)
    analyse_btn = st.button("Fetch & Analyze")

def fetch_price_history(symbol, days, interval):
    end = datetime.now()
    start = end - timedelta(days=days)
    try:
        df = yf.download(symbol, start=start, end=end + timedelta(days=1), interval=interval, progress=False)
        if df is None or df.empty:
            return None
        df = df.dropna()
        return df
    except Exception as e:
        st.error(f"Price fetch error: {e}")
        return None

def fetch_option_chain(symbol):
    # yfinance supports options for some tickers; best-effort
    try:
        t = yf.Ticker(symbol)
        exp = t.options
        if not exp:
            return None
        # pick nearest expiry
        nearest = exp[0]
        opt = t.option_chain(nearest)
        calls = opt.calls
        puts = opt.puts
        return {"expiry": nearest, "calls": calls, "puts": puts}
    except Exception:
        return None

def fetch_news(symbol):
    if not NEWS_KEY:
        return []
    q = symbol
    url = "https://newsapi.org/v2/everything"
    params = {"q": q, "pageSize": 5, "sortBy":"publishedAt", "apiKey": NEWS_KEY}
    try:
        r = requests.get(url, params=params, timeout=8).json()
        articles = r.get("articles", [])
        return [{"title": a["title"], "source": a["source"]["name"], "url": a["url"]} for a in articles]
    except Exception:
        return []

def call_openai_analysis(prompt):
    if not OPENAI_KEY:
        return "OpenAI key not configured â€” cannot run LLM analysis. Set OPENAI_API_KEY in Render/Env to enable."
    try:
        resp = openai.ChatCompletion.create(
            model="gpt-4o-mini" if "gpt-4o-mini" in openai.Model.list() else "gpt-4o",
            messages=[{"role":"system","content":"You are a concise intraday NSE F&O analyst. Use technicals and news to make short actionable guidance."},
                      {"role":"user","content": prompt}],
            max_tokens=300,
            temperature=0.2
        )
        return resp.choices[0].message.content.strip()
    except Exception as e:
        return f"OpenAI error: {e}"

def create_signal(df):
    close = df["Close"]
    latest = close.iloc[-1]
    r = rsi(close)
    macd_line, signal_line, hist = macd(close)
    ema20 = ema(close, 20)
    v = vwap(df)

    last_rsi = r.iloc[-1]
    last_macd = macd_line.iloc[-1] - signal_line.iloc[-1]
    last_price = latest
    last_ema = ema20.iloc[-1]
    last_vwap = v.iloc[-1]

    # Simple rule-based combination
    buy_cond = (last_rsi < 40 and last_macd > 0 and last_price > last_ema) or (last_price > last_vwap and last_macd > 0)
    sell_cond = (last_rsi > 65 and last_macd < 0 and last_price < last_ema) or (last_price < last_vwap and last_macd < 0)

    if buy_cond and not sell_cond:
        return "BUY"
    elif sell_cond and not buy_cond:
        return "SELL"
    else:
        return "HOLD"

if analyse_btn:
    st.info(f"Fetching {full_symbol} data...")
    df = fetch_price_history(full_symbol, days_back, interval)
    if df is None or df.empty:
        st.error("No price data found. Try another symbol or increase days.")
    else:
        st.success("Price data loaded.")
        # Indicators
        df["EMA20"] = ema(df["Close"], 20)
        df["RSI14"] = rsi(df["Close"], 14)
        macd_line, signal_line, hist = macd(df["Close"])
        df["MACD"] = macd_line
        df["MACD_SIGNAL"] = signal_line
        df["VWAP"] = vwap(df)
        st.subheader(f"{full_symbol} â€” Last {days_back} days ({interval})")
        st.line_chart(df["Close"])
        st.write("Latest values:")
        latest_row = df.tail(1).T
        st.table(latest_row)

        # Signals
        signal = create_signal(df)
        if signal == "BUY":
            st.success(f"ðŸ”” SIGNAL: BUY")
        elif signal == "SELL":
            st.error(f"ðŸ”” SIGNAL: SELL")
        else:
            st.info("ðŸ”” SIGNAL: HOLD")

        # Option chain (best-effort)
        with st.expander("Option Chain (best-effort)"):
            oc = fetch_option_chain(full_symbol)
            if oc:
                st.write(f"Nearest expiry: {oc['expiry']}")
                st.write("Top 5 Calls:")
                st.dataframe(oc["calls"].sort_values("openInterest", ascending=False).head(10))
                st.write("Top 5 Puts:")
                st.dataframe(oc["puts"].sort_values("openInterest", ascending=False).head(10))
                # compute greeks approximately for top strike (example)
                try:
                    top = oc["calls"].sort_values("openInterest", ascending=False).iloc[0]
                    S = df["Close"].iloc[-1]
                    K = float(top["strike"])
                    # approximate time to expiry in years
                    expiry_dt = pd.to_datetime(oc["expiry"])
                    T = max((expiry_dt - datetime.now()).days / 365.0, 1/365)
                    r = 0.06
                    sigma = float(top.get("impliedVolatility", 0.3) or 0.3)
                    greeks = bs_greeks(S, K, T, r, sigma, "call")
                    st.write("Sample Greeks (for top-call):", greeks)
                except Exception:
                    st.write("Could not compute greeks for option chain.")
            else:
                st.write("Option chain not available via yfinance for this symbol (India tickers often lack option chains).")

        # News
        with st.expander("Latest News & AI Sentiment"):
            news = fetch_news(symbol_input)
            if news:
                for n in news:
                    st.markdown(f"- [{n['title']}]({n['url']}) â€” *{n['source']}*")
            else:
                st.write("No news fetched (NEWS_API_KEY not set or News API returned no results).")

            # Prepare AI prompt
            ai_input = {
                "symbol": full_symbol,
                "latest_price": float(df["Close"].iloc[-1]),
                "rsi": float(df["RSI14"].iloc[-1]),
                "macd": float(df["MACD"].iloc[-1] - df["MACD_SIGNAL"].iloc[-1]),
                "ema20": float(df["EMA20"].iloc[-1]),
                "vwap": float(df["VWAP"].iloc[-1]),
                "signal": signal,
                "recent_close": df["Close"].tail(10).tolist(),
                "news_headlines": [n["title"] for n in news] if news else []
            }
            prompt = f"""
You are an intraday NSE F&O analyst. Analyze the following JSON and give:
1) A one-line bias (Bullish/Neutral/Bearish).
2) Two clear reasons (technical + news/OI if present).
3) A concise actionable note: entry zone, stop-loss, target (if applicable).
Data: {ai_input}
Limit answer to 120 words, short bullet points.
"""
            st.write("AI analysis (from OpenAI):")
            ai_answer = call_openai_analysis(prompt)
            st.write(ai_answer)

st.write("---")
st.caption("Prototype â€¢ Uses yfinance, basic indicators, optional OpenAI. Improve by connecting broker/exchange for real-time F&O data and a robust news source.")
